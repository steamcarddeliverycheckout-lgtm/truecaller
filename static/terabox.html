<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terabox Video Downloader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .input-section {
            margin-bottom: 25px;
        }

        .input-label {
            display: block;
            font-size: 0.95em;
            color: #4a5568;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .url-input {
            width: 100%;
            padding: 15px;
            font-size: 1em;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .url-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-download {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-download:active {
            transform: translateY(0);
        }

        .btn-download:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            display: none;
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            display: none;
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .success-message.show {
            display: block;
        }

        .results {
            display: none;
            margin-top: 30px;
        }

        .results.show {
            display: block;
        }

        .video-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: box-shadow 0.3s;
        }

        .video-card:hover {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .video-header {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .video-thumbnail {
            width: 160px;
            height: 90px;
            border-radius: 8px;
            object-fit: cover;
            background: #e2e8f0;
        }

        .video-info {
            flex: 1;
        }

        .video-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .video-size {
            color: #718096;
            font-size: 0.95em;
            margin-bottom: 15px;
        }

        .video-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-stream {
            background: #48bb78;
            color: white;
        }

        .btn-stream:hover {
            background: #38a169;
            transform: translateY(-1px);
        }

        .btn-direct {
            background: #4299e1;
            color: white;
        }

        .btn-direct:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }

        .video-player {
            display: none;
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .video-player.show {
            display: block;
        }

        .video-player video {
            width: 100%;
            height: auto;
            background: #000;
        }

        .no-thumbnail {
            width: 160px;
            height: 90px;
            background: linear-gradient(135deg, #e2e8f0, #cbd5e0);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #718096;
            font-size: 0.9em;
        }

        .result-header {
            font-size: 1.3em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        @media (max-width: 640px) {
            .header h1 {
                font-size: 2em;
            }

            .video-header {
                flex-direction: column;
            }

            .video-thumbnail,
            .no-thumbnail {
                width: 100%;
                height: 180px;
            }

            .video-actions {
                flex-direction: column;
            }

            .btn-action {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì• Terabox Video Downloader</h1>
            <p>Download or stream videos from Terabox links</p>
        </div>

        <div class="main-card">
            <div class="input-section">
                <label class="input-label">Enter Terabox URL</label>
                <input 
                    type="url" 
                    id="urlInput" 
                    class="url-input" 
                    placeholder="https://teraboxurl.com/s/..."
                    autocomplete="off"
                >
            </div>

            <button id="downloadBtn" class="btn-download" onclick="fetchVideo()">
                üîç Get Video Links
            </button>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px;">Fetching video information...</p>
            </div>

            <div id="error" class="error-message"></div>
            <div id="success" class="success-message"></div>

            <div id="results" class="results"></div>
        </div>
    </div>

    <script>
        async function fetchVideo() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();
            
            if (!url) {
                showError('Please enter a Terabox URL');
                return;
            }

            // Reset UI
            hideError();
            hideResults();
            
            const loading = document.getElementById('loading');
            const downloadBtn = document.getElementById('downloadBtn');
            
            loading.classList.add('active');
            downloadBtn.disabled = true;
            
            try {
                const response = await fetch('/terabox/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to fetch video information');
                }

                if (data.ok && data.videos && data.videos.length > 0) {
                    displayResults(data.videos);
                } else {
                    showError('No videos found in the provided link');
                }
                
            } catch (error) {
                showError('Error: ' + error.message);
            } finally {
                loading.classList.remove('active');
                downloadBtn.disabled = false;
            }
        }

        function displayResults(videos) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            const header = document.createElement('div');
            header.className = 'result-header';
            header.textContent = `Found ${videos.length} video${videos.length > 1 ? 's' : ''}`;
            resultsDiv.appendChild(header);
            
            videos.forEach((video, index) => {
                const videoCard = createVideoCard(video, index);
                resultsDiv.appendChild(videoCard);
            });
            
            resultsDiv.classList.add('show');
        }

        function createVideoCard(video, index) {
            const card = document.createElement('div');
            card.className = 'video-card';
            
            const header = document.createElement('div');
            header.className = 'video-header';
            
            // Thumbnail
            const thumbnailDiv = document.createElement('div');
            if (video.thumbnails && video.thumbnails['360x270']) {
                const img = document.createElement('img');
                img.src = video.thumbnails['360x270'];
                img.className = 'video-thumbnail';
                img.onerror = function() {
                    this.style.display = 'none';
                    const noThumb = document.createElement('div');
                    noThumb.className = 'no-thumbnail';
                    noThumb.innerHTML = 'üé¨ No Preview';
                    this.parentElement.appendChild(noThumb);
                };
                thumbnailDiv.appendChild(img);
            } else {
                const noThumb = document.createElement('div');
                noThumb.className = 'no-thumbnail';
                noThumb.innerHTML = 'üé¨ No Preview';
                thumbnailDiv.appendChild(noThumb);
            }
            header.appendChild(thumbnailDiv);
            
            // Video Info
            const infoDiv = document.createElement('div');
            infoDiv.className = 'video-info';
            
            const title = document.createElement('div');
            title.className = 'video-title';
            title.textContent = video.title || 'Untitled Video';
            infoDiv.appendChild(title);
            
            const size = document.createElement('div');
            size.className = 'video-size';
            size.textContent = `Size: ${video.size || 'Unknown'}`;
            infoDiv.appendChild(size);
            
            // Action buttons
            const actions = document.createElement('div');
            actions.className = 'video-actions';
            
            // Stream button (download to server first)
            const streamBtn = document.createElement('button');
            streamBtn.className = 'btn-action btn-stream';
            streamBtn.innerHTML = '‚ñ∂Ô∏è Stream Video';
            streamBtn.onclick = () => downloadAndStreamVideo(video.download_link, video.title, index);
            actions.appendChild(streamBtn);
            
            // Download button
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'btn-action btn-direct';
            downloadBtn.innerHTML = '‚¨áÔ∏è Direct Download';
            downloadBtn.onclick = () => downloadVideo(video.download_link, video.title);
            actions.appendChild(downloadBtn);
            
            infoDiv.appendChild(actions);
            header.appendChild(infoDiv);
            card.appendChild(header);
            
            // Video player container
            const playerDiv = document.createElement('div');
            playerDiv.id = `player-${index}`;
            playerDiv.className = 'video-player';
            card.appendChild(playerDiv);
            
            return card;
        }

        async function downloadAndStreamVideo(url, title, index) {
            if (!url) {
                showError('No download URL available');
                return;
            }
            
            const playerDiv = document.getElementById(`player-${index}`);
            
            // Toggle player visibility
            if (playerDiv.classList.contains('show')) {
                playerDiv.classList.remove('show');
                playerDiv.innerHTML = '';
                return;
            }
            
            // Hide all other players
            document.querySelectorAll('.video-player').forEach(p => {
                p.classList.remove('show');
                p.innerHTML = '';
            });
            
            // Show loading in player div
            playerDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #667eea;"><div class="spinner"></div><p style="margin-top: 15px;">Downloading video to server...</p></div>';
            playerDiv.classList.add('show');
            playerDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            try {
                // Download video to server
                const response = await fetch('/terabox/download-to-server', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to download video to server');
                }
                
                if (data.ok && data.stream_url) {
                    // Create and show video player with server stream
                    const video = document.createElement('video');
                    video.controls = true;
                    video.autoplay = true;
                    video.src = data.stream_url;
                    
                    playerDiv.innerHTML = '';
                    playerDiv.appendChild(video);
                    
                    // Show success message briefly
                    showSuccess(`Video downloaded and ready to stream!`);
                } else {
                    throw new Error('No stream URL received from server');
                }
                
            } catch (error) {
                playerDiv.innerHTML = `<div style="text-align: center; padding: 40px; color: #c53030;"><p>‚ùå Error: ${error.message}</p></div>`;
                showError('Failed to download video: ' + error.message);
            }
        }

        function streamVideo(url, index) {
            if (!url) {
                showError('No stream URL available');
                return;
            }
            
            const playerDiv = document.getElementById(`player-${index}`);
            
            // Toggle player visibility
            if (playerDiv.classList.contains('show')) {
                playerDiv.classList.remove('show');
                playerDiv.innerHTML = '';
            } else {
                // Hide all other players
                document.querySelectorAll('.video-player').forEach(p => {
                    p.classList.remove('show');
                    p.innerHTML = '';
                });
                
                // Create and show video player
                const video = document.createElement('video');
                video.controls = true;
                video.autoplay = true;
                video.src = url;
                
                playerDiv.innerHTML = '';
                playerDiv.appendChild(video);
                playerDiv.classList.add('show');
                
                // Scroll to player
                playerDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function downloadVideo(url, title) {
            if (!url) {
                showError('No download URL available');
                return;
            }
            
            // Create a temporary link and trigger download
            const link = document.createElement('a');
            link.href = url;
            link.download = title || 'video.mp4';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            hideSuccess();
        }

        function hideError() {
            const errorDiv = document.getElementById('error');
            errorDiv.classList.remove('show');
            errorDiv.textContent = '';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = message;
            successDiv.classList.add('show');
            hideError();
            
            // Auto-hide success message after 3 seconds
            setTimeout(() => {
                hideSuccess();
            }, 3000);
        }

        function hideSuccess() {
            const successDiv = document.getElementById('success');
            successDiv.classList.remove('show');
            successDiv.textContent = '';
        }

        function hideResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.remove('show');
            resultsDiv.innerHTML = '';
        }

        // Allow Enter key to submit
        document.getElementById('urlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fetchVideo();
            }
        });
    </script>
</body>
</html>
